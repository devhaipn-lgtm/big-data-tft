{% extends 'base.html' %}

{% block content %}
<div class="layout-container">
    
    <aside class="sidebar">
        <h3 style="color:white; margin-top:0;">Data Explorer</h3>
        <p style="color:#888; font-size:0.85rem;">Analyze performance deltas based on unit star levels.</p>
        
        <form action="/explorer" method="GET">
            {% for i in range(3) %}
            <div style="margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px;">
                <label style="font-size:0.75rem; color:#aaa; display:block; margin-bottom:8px; text-transform:uppercase; letter-spacing:1px;">
                    Slot {{ i+1 }}
                </label>
                
                <div style="display:flex; gap:8px;">
                    <select name="s{{ i+1 }}" style="flex:2.5; padding:10px; background:#111; color:white; border:1px solid #444; border-radius:4px; font-size:0.9rem;">
                        <option value="">-- Empty --</option>
                        {% for u in units %}
                        <option value="{{ u.id }}" {% if selected[i] == u.id %}selected{% endif %}>
                            {{ u.name }}
                        </option>
                        {% endfor %}
                    </select>
                    
                    <select name="star{{ i+1 }}" style="flex:1; padding:10px; background:#111; color:white; border:1px solid #444; border-radius:4px; text-align:center; font-weight:bold;">
                        <option value="1" {% if selected_stars[i] == '1' %}selected{% endif %}>1 â˜…</option>
                        <option value="2" {% if selected_stars[i] == '2' %}selected{% endif %}>2 â˜…</option>
                        <option value="3" {% if selected_stars[i] == '3' %}selected{% endif %}>3 â˜…</option>
                    </select>
                </div>
            </div>
            {% endfor %}

            <button type="submit" style="width:100%; padding:14px; background:var(--accent); color:black; border:none; border-radius:4px; font-weight:bold; cursor:pointer; text-transform:uppercase;">
                Run Deep Analysis
            </button>
        </form>
    </aside>

    <main class="content-area">
        {% if results %}
        
        <div class="panel" style="margin-bottom: 25px; display:flex; align-items:center; justify-content: space-between; border-left: 4px solid var(--accent);">
            <div style="display:flex; align-items:center; gap:20px;">
                <div class="icon-box" style="width:70px; height:70px; border-color:var(--accent); background:#000;">
                    <img src="{{ get_icon(selected[active_idx]) }}">
                </div>
                <div>
                    <h1 style="margin:0; text-transform:uppercase; font-size:1.8rem; letter-spacing:2px;">{{ clean_id(selected[active_idx]) }}</h1>
                    <div style="color:var(--accent); font-weight:bold; font-size:1rem; margin-top:4px;">
                        CURRENT FOCUS: {{ selected_stars[active_idx] }} STAR
                    </div>
                </div>
            </div>

            {% if header_stats %}
            <div style="text-align: right;">
                <div style="color:#888; font-size:0.75rem; text-transform:uppercase; letter-spacing:1px;">Global Avg placement</div>
                <div style="font-size:2.8rem; font-weight:900; color: {{ '#48bb78' if header_stats.avg_place < 4.5 else '#f56565' }}; line-height:0.9;">
                    #{{ "%.2f"|format(header_stats.avg_place) }}
                </div>
                <div style="font-size:0.8rem; color:#555; margin-top:4px;">{{ header_stats.play_count }} total games</div>
            </div>
            {% endif %}
        </div>

        <div class="grid-3">
            
            <div class="panel">
                <div class="panel-header" style="color:var(--green);">Top Partner Synergies</div>
                <p style="font-size:0.75rem; color:#666; margin-top:-10px; margin-bottom:15px;">Placement variance when paired with:</p>
                {% for p in results.top_partners %}
                <div class="unit-row" style="padding:10px 0;">
                    <div class="icon-box" style="width:40px; height:40px;"><img src="{{ get_icon(p.unit_b) }}"></div>
                    <div style="flex:1; margin-left:12px;">
                        <div style="font-weight:bold; font-size:0.95rem;">{{ clean_id(p.unit_b) }}</div>
                        <div style="font-size:0.75rem; color:#555;">{{ p.count }} samples</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:900; font-size:1.1rem; color: {{ 'var(--green)' if p.delta < 0 else 'var(--red)' }}">
                            {{ "%+.2f"|format(p.delta) }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="panel">
                <div class="panel-header" style="color:var(--accent);">Active Trait Deltas</div>
                <p style="font-size:0.75rem; color:#666; margin-top:-10px; margin-bottom:15px;">Efficiency gain from active synergies:</p>
                {% for t in results.top_traits %}
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid #222;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="icon-box" style="width:28px; height:28px; border:none; border-radius:0;">
                           <img src="{{ get_icon(t.trait) }}" onerror="this.style.display='none'">
                        </div>
                        <span style="font-size:0.9rem; font-weight:500;">{{ clean_id(t.trait) }}</span>
                    </div>
                    <div style="font-weight:900; font-size:1.1rem; color: {{ 'var(--green)' if t.delta < 0 else 'var(--red)' }}">
                        {{ "%+.2f"|format(t.delta) }}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="panel">
                <div class="panel-header" style="color:#81e6d9;">Best-in-Slot Items</div>
                <p style="font-size:0.75rem; color:#666; margin-top:-10px; margin-bottom:15px;">Impact of specific item loadouts:</p>
                {% for i in results.top_items %}
                <div class="unit-row" style="padding:8px 0;">
                    <div class="icon-box" style="width:36px; height:36px; border-radius:4px; border-color:#333;">
                        <img src="{{ get_icon(i.item) }}">
                    </div>
                    <div style="flex:1; margin-left:12px;">
                        <div style="font-size:0.9rem;">{{ clean_id(i.item) }}</div>
                    </div>
                    <div style="font-weight:900; font-size:1.1rem; color: {{ 'var(--green)' if i.delta < 0 else 'var(--red)' }}">
                        {{ "%+.2f"|format(i.delta) }}
                    </div>
                </div>
                {% endfor %}
            </div>

        </div>
        {% else %}
        <div style="text-align: center; margin-top: 15vh; opacity: 0.3;">
            <div style="font-size: 5rem; margin-bottom: 20px;">ðŸ“Š</div>
            <h2 style="text-transform: uppercase; letter-spacing: 3px;">Ready for Analysis</h2>
            <p>Select unit and star levels in the sidebar to generate synergistic deltas.</p>
        </div>
        {% endif %}
    </main>
</div>
{% endblock %}